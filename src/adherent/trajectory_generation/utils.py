# SPDX-FileCopyrightText: Fondazione Istituto Italiano di Tecnologia
# SPDX-License-Identifier: BSD-3-Clause

import math
import numpy as np
from scenario import core
from typing import List, Dict
from dataclasses import dataclass
from gym_ignition.utils import misc
from scenario import gazebo as scenario
from adherent.MANN.utils import read_from_file
from adherent.data_processing.utils import iCub

import matplotlib as mpl
mpl.rcParams['toolbar'] = 'None'
import matplotlib.pyplot as plt

# =====================
# MODEL INSERTION UTILS
# =====================

@dataclass
class SphereURDF:
    """Class for defining a sphere urdf with parametric radius and color."""

    radius: float = 0.5
    color: tuple = (1, 1, 1, 1)

    def urdf(self) -> str:
        i = 2.0 / 5 * 1.0 * self.radius * self.radius
        urdf = f"""
            <robot name="sphere_robot" xmlns:xacro="http://www.ros.org/wiki/xacro">

                <!-- ====== -->
                <!-- COLORS -->
                <!-- ====== -->
                <material name="custom">
                    <color rgba="{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}"/>
                </material>
                <gazebo reference="sphere">
                    <visual>
                      <material>
                        <diffuse>{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}</diffuse>
                      </material>
                    </visual>
                    <collision>
                        <surface>
                          <friction>
                            <ode>
                              <mu>0.0</mu>
                            </ode>
                          </friction>
                        </surface>
                    </collision>
                </gazebo>

                <!-- ===== -->
                <!-- LINKS -->
                <!-- ===== -->

                <link name="sphere">
                    <inertial>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                      <mass value="1.0"/>
                      <inertia ixx="{i}" ixy="0" ixz="0" iyy="{i}" iyz="0" izz="{i}"/>
                    </inertial>
                    <visual>
                      <geometry>
                        <sphere radius="{self.radius}"/>
                      </geometry>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                      <material name="custom">
                        <color rgba="{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}"/>
                      </material>
                    </visual>
                    <collision>
                      <geometry>
                        <sphere radius="{self.radius}"/>
                      </geometry>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                    </collision>
                </link>
                <gazebo reference="sphere">
                  <collision>
                    <surface>
                      <friction>
                        <ode>
                          <mu>0.0</mu>
                          <mu2>0.0</mu2>
                        </ode>
                      </friction>
                    </surface>
                  </collision>
                </gazebo>
            </robot>"""

        return urdf

class Shape:
    """Helper class to simplify shape insertion."""

    def __init__(self,
                 world: scenario.World,
                 position: List[float] = (0, 0, 0),
                 orientation: List[float] = (1, 0, 0, 0),
                 model_string: str = SphereURDF(radius=0.02).urdf()):
        self.sdf = misc.string_to_file(model_string)

        # Assing incremental default name when multiple shapes are inserted
        name = scenario.get_model_name_from_sdf(self.sdf)
        index = 0
        while name in world.model_names():
            name = f"{name}{index}"

        # Insert the shape in the world
        assert world.insert_model(self.sdf, core.Pose(position, orientation), name)

        # Get and store the model and the world
        self.model = world.get_model(model_name=name)
        self.world = world

# =====================
# JOYSTICK DEVICE UTILS
# =====================

def quadratic_bezier(p0: np.array, p1: np.array, p2: np.array, t: np.array) -> List:
    """Define a discrete quadratic Bezier curve. Given the initial point p0, the control point p1 and
       the final point p2, the quadratic Bezier consists of t points and is defined by:
               Bezier(p0, p1, p2, t) = (1 - t)^2 p0 + 2t (1 - t) p1 + t^2 p2
    """

    quadratic_bezier = []

    for t_i in t:
        p_i = (1 - t_i) * (1 - t_i) * p0 + 2 * t_i * (1 - t_i) * p1 + t_i * t_i * p2
        quadratic_bezier.append(p_i)

    return quadratic_bezier

def compute_angle_wrt_x_positive_semiaxis(current_facing_direction: List) -> float:
    """Compute the angle between the current facing direction and the x positive semiaxis."""

    # Define the x positive semiaxis
    x_positive_semiaxis = np.asarray([1, 0])

    # Compute the yaw between the current facing direction and the world x axis
    cos_theta = np.dot(x_positive_semiaxis, current_facing_direction) # unitary norm vectors
    sin_theta = np.cross(x_positive_semiaxis, current_facing_direction) # unitary norm vectors
    angle = math.atan2(sin_theta, cos_theta)

    return angle

# ===========================
# TRAJECTORY GENERATION UTILS
# ===========================

def define_initial_nn_X(robot: str) -> List:
    """Define the robot-specific initial input X for the network used for trajectory generation."""

    if robot == "iCubV2_5":
        # Initial input manually retrieved from a standing pose
        initial_nn_X = [[0.2119528955450237, -0.0030393414305661757, 0.2088665596830631, -0.0021020581878808007,
                         0.20531231168918174, -0.0008621646186016302, 0.2038031784172399, 0.0006000018873639539,
                         0.20492310200003655, 0.00219387868363895, 0.0, 0.0, -0.2861243642562259, 0.009288430936687906,
                         -0.31823372134674327, 0.0041163061304422335, -0.3351330296979504, 0.00013665165796125482,
                         -0.32760743228415534, 0.0013394518793597135, -0.28954434529500506, -0.002034172225900831,
                         -0.22271595678165187, -0.007108432655308732, 0.4874557110316117, -0.060262978658173996,
                         0.483219430286254, -0.05549580293883961, 0.48355811354675093, -0.05073190069674229,
                         0.48430037825453315, -0.0463878541965186, 0.47622379318033997, -0.042673799121161156, 0.0,
                         -0.001670958751021921, 0.48823702730673707, -0.012628077673047147, 0.4985278001448309,
                         -0.017930827973037217, 0.4894521106023875, -0.013467714394521855, 0.48597445992611943,
                         -0.004418383745209343, 0.4891737721962037, -0.0006736504004182218, 0.4998745767668644,
                         -6.208532325985457e-05, -0.14660114753459738, -0.013635038569482734, -0.14972572660656353,
                         -0.013889675494643422, -0.14485898865197464, -0.014291839679283299, -0.13868430844742163,
                         -0.015641834593965512, -0.14136717424413048, -0.017874811642905507, -0.15142562459589684,
                         -0.020944871631760793, -0.07793121543356057, -0.002198970320957779, 0.12319525161531483,
                         0.002993875070530926, -1.1538873156781917, 0.01723559513698802, -1.495295660555109,
                         0.0010038652592341854, -1.8281665557305795, 0.0006766967160280221, -2.159682389892566,
                         -0.006655788893852345, -2.4211997845061326, -0.9981968, -0.3760584, 0.37910417, 0.65148425,
                         0.3296967, 0.40070292, -1.0328596, -0.36308038, 0.41093844, 0.64171183, 0.28167534, 0.3818131,
                         -1.9024365, 0.00088662654, 0.0018205047, 0.35245338, -0.33301216, -0.21851036, -0.73831433,
                         0.61941016, 0.8847597, -0.98411304, -0.5619794, 0.03115137, -0.091870524, 0.35733885,
                         -0.366953, -0.19864298, -0.71252215, 0.70668554, 0.8847598, -0.98411304, 0.0064472854,
                         -0.003662251, -0.027689233, -0.019645333, -0.010648936, -0.00738357, 0.015316837, 0.04705859,
                         0.011168551, -0.013807453, -0.0048871785, -0.027151093, -0.12258834, -0.028669998, 0.04093896,
                         -0.0797086, -0.010067629, 0.10308291, 0.07587971, -0.0666933, -0.018514698, 0.019428264,
                         0.0027377363, 0.042420693, -0.009432776, 0.048711963, -0.0032096095, -0.0069472883,
                         0.016040523, 0.0183498, -0.01851473, 0.019428236]]
    elif robot == "iCubV3":
        initial_nn_X = [[-0.3864105139086539, 0.05556262545645358, -0.3279339644512662, 0.035731156631418175, -0.24766046411829562,
                         0.0015517482454675483, -0.17613580239587684, -0.022647366753836905, -0.09825752026883232, -0.023081402044857577,
                         0.0, 0.0, 0.08090515622421977, 0.02444664899093374, 0.16464175288111751, 0.024822835101984044, 0.26197341885262937,
                         -0.010025500447551901, 0.3612001663544216, -0.04526584556838146, 0.45819686035043117, -0.05521702121696775,
                         0.5567241516406287, -0.04038548277185585, 0.9992696670111196, 0.038211681348587594, 0.9998732480497898,
                         0.015921301277330456, 0.9984987431986877, 0.05477462761754895, 0.9974342139047502, 0.07158902801556369,
                         0.998304680071859, 0.058204516548317646, 1.0, 1.1460489465514688e-16, 0.9992982332645707, -0.03745718882014107,
                         0.9986705476026108, -0.05154742817155567, 0.9999564873065029, 0.009328638359369472, 0.9943507671230382,
                         0.10614401500709068, 0.9929144965088392, 0.11883098342855829, 0.9994392232348986, 0.033484907938093326,
                         0.18204689117851441, -0.05046998009417825, 0.5330287542176003, -0.19945826084855334, 0.4825442954026412,
                         -0.21514008054064546, 0.24786479803169664, -0.05891736061486256, 5.432895917460883e-15, 1.1395266825452786e-15,
                         0.7290503882546148, 0.35692923672349497, 0.8803485505966717, 0.16397303929460766, 0.7696219351416007,
                         -0.24444716576438877, 0.8145344205469396, -0.17814283655303456, 0.6633709065984218, -0.1583901146973466,
                         -2.7164479587304413e-15, -5.697633412726393e-16, 0.9275403057432104, 0.3781500158778345, 0.981768494439995,
                         0.10816449559042442, 0.02335406695057977, -0.03241570576614559, -0.07824798720269244, 0.07081679450901583,
                         -0.051996872132012026, -0.0930786619267621, 0.09795341888023411, -0.021845653901877392, -0.642102961744835,
                         -0.6958781518310178, -0.07279616770023531, 0.07174362081956087, 0.4608776195455833, -0.09654620840378886,
                         -0.19521293472017462, 0.20943951023931956, -0.2952252789071809, -0.05235987755982989, 0.11481968594153659,
                         -0.33188605729362625, 0.17303141638326325, 0.1659012021069553, -0.017039150843140567, -0.03816586415208088,
                         -0.2765783184162156, 0.20943951023931956, -0.452698745711848, 0.04953112036529866, 0.10903501864532289,
                         -0.33188605729362625, 0.0, -0.9041377653611689, -0.0803938583565908, 0.5693363360328885, 0.01209485815405198,
                         -0.8436774171046484, 0.16552907769013073, 1.3729446256515614, 0.45800814492566383, -0.3558663480982629,
                         -3.145913606607048, -1.7952054486503444, -0.43584546127248686, 0.05956721871656773, 0.14989704707754625,
                         -0.011374468237963092, -0.32474079116435184, 0.0, 0.341511985823445, 0.0, -0.22140782077813698,
                         0.0001355865215130203, -7.081963210447961e-05, 0.002224311253991307, -0.02184735663294142, 0.10680888589126095,
                         0.19799939775860254, 0.0, 0.044461474309243076, 0.14013190758040728, 0.018441439582583125, 0.0001355865215130203,
                         0.0]]

    else:
        raise Exception("Initial network input X only defined for iCubV2_5 and iCubV3.")

    return initial_nn_X

def define_initial_past_trajectory(robot: str) -> (List, List, List):
    """Define the robot-specific initialization of the past trajectory data used for trajectory generation."""

    # The above quantities are expressed in the frame specified by the initial base position and the facing direction

    if robot == "iCubV2_5":

        # Initial past base positions manually retrieved from a standing pose
        initial_past_trajectory_base_pos = [[-0.0006781887991487454, 0.0005382023957937025],
                                    [-0.0006647239425803457, 0.0005273088163705415],
                                    [-0.0006512643546792456, 0.0005164206039375526],
                                    [-0.0006377953293649197, 0.0005055375639224852],
                                    [-0.0006243223759395536, 0.0004946598636862636],
                                    [-0.0006108399997998801, 0.0004837873556333961],
                                    [-0.0005973672439964133, 0.0004729208481432019],
                                    [-0.0005838774043584994, 0.000462058202637307],
                                    [-0.0005703864089978013, 0.00045120053923471386],
                                    [-0.0005568976029413277, 0.00044034668352684476],
                                    [-0.0005433944044652785, 0.00042950336076639064],
                                    [-0.0005298872456197738, 0.00041866148475417985],
                                    [-0.0005163891602592688, 0.0004078273201884596],
                                    [-0.0005028772288014707, 0.0003969962242274589],
                                    [-0.0004893568206573056, 0.0003861719082838056],
                                    [-0.0004758425651066602, 0.0003753518627324191],
                                    [-0.00046231312340075495, 0.00036453423210500597],
                                    [-0.00044878604841946013, 0.00035372630074053177],
                                    [-0.0004352530747953605, 0.00034292112934518164],
                                    [-0.00042172149782268163, 0.00033212353566379113],
                                    [-0.0004081797610404143, 0.0003213324600119949],
                                    [-0.0003946302109381543, 0.0003105427764365998],
                                    [-0.00038108095663678086, 0.000299761652046352],
                                    [-0.0003675236365612126, 0.0002889855808213132],
                                    [-0.0003539697410959713, 0.0002782137851076101],
                                    [-0.00034041768049816534, 0.0002674457780258597],
                                    [-0.00032684196379834704, 0.000256685071996519],
                                    [-0.00031326716933113526, 0.0002459287909804182],
                                    [-0.00029969788590518485, 0.00023517725075197912],
                                    [-0.00028611917067016793, 0.0002244313688890221],
                                    [-0.0002725307912706841, 0.00021369435529300127],
                                    [-0.00025894933834369005, 0.00020295593849716727],
                                    [-0.00024536710778585904, 0.00019222322705029503],
                                    [-0.000231767236595024, 0.00018150092194441208],
                                    [-0.00021815871347549421, 0.00017077920312574124],
                                    [-0.00020455895870665294, 0.00016006834116839483],
                                    [-0.00019095141496312167, 0.00014936037600883187],
                                    [-0.0001773345902858732, 0.00013865422551428646],
                                    [-0.00016373661066682184, 0.0001279587235979194],
                                    [-0.00015009695166202328, 0.00011726740411708459],
                                    [-0.00013648127926164732, 0.0001065802552652773],
                                    [-0.00012284291258793977, 9.589807810900453e-05],
                                    [-0.00010921928546949104, 8.522111760777935e-05],
                                    [-9.558259372471922e-05, 7.454690983824729e-05],
                                    [-8.193676260565677e-05, 6.388213666527646e-05],
                                    [-6.829031781475642e-05, 5.3223206770590906e-05],
                                    [-5.4640516832067336e-05, 4.256765707546707e-05],
                                    [-4.099221572739473e-05, 3.191479359366577e-05],
                                    [-2.733307550666302e-05, 2.1273139149335884e-05],
                                    [-1.3662890395487173e-05, 1.063469931815647e-05],
                                    [0.0, 0.0]]

        # Initial past facing directions manually retrieved from a standing pose
        initial_past_trajectory_facing_dirs = [[0.9998092990492257, -0.019528582506055422],
                                        [0.9998168506034699, -0.01913805761718488],
                                        [0.9998242495649122, -0.018747532689931887],
                                        [0.9998314960180585, -0.018357003303677545],
                                        [0.9998385899327197, -0.01796647103220058],
                                        [0.9998455313288402, -0.0175759347333077],
                                        [0.9998523201559695, -0.017185397252453403],
                                        [0.9998589564711968, -0.016794855293497706],
                                        [0.9998654401899228, -0.01640431387812107],
                                        [0.9998717713630115, -0.01601377005560508],
                                        [0.9998779500423899, -0.015623220507573019],
                                        [0.9998839761713595, -0.015232668700922845],
                                        [0.9998898497279782, -0.014842116121402793],
                                        [0.9998955707342037, -0.014451561373105574],
                                        [0.99990113916948, -0.014061005923328785],
                                        [0.9999065550758257, -0.013670446824995854],
                                        [0.9999118184095479, -0.013279887232614156],
                                        [0.9999169292288519, -0.012889322772870165],
                                        [0.9999218874586415, -0.01249875918429945],
                                        [0.9999266931712342, -0.012108190766611501],
                                        [0.9999313462939388, -0.011717623427582714],
                                        [0.9999358468605792, -0.011327054481003577],
                                        [0.9999401948901391, -0.010936482207298913],
                                        [0.9999443903613943, -0.010545908437858902],
                                        [0.9999484332728986, -0.010155333331557733],
                                        [0.99995232364119, -0.009764755223974861],
                                        [0.999956061452534, -0.009374175394966032],
                                        [0.9999596466925486, -0.008983595411236894],
                                        [0.99996307938682, -0.008593012465219062],
                                        [0.9999663595078725, -0.008202429674901989],
                                        [0.9999694870684395, -0.007811845625800506],
                                        [0.999972462068608, -0.007421260300351187],
                                        [0.9999752844950315, -0.007030675577780891],
                                        [0.9999779543599308, -0.006640089918632473],
                                        [0.9999804716745225, -0.00624950154805433],
                                        [0.9999828364186417, -0.005858913562069191],
                                        [0.9999850486165925, -0.005468321796556921],
                                        [0.9999871082497419, -0.005077729248250766],
                                        [0.9999890153097547, -0.004687137700856822],
                                        [0.999990769812952, -0.004296543831877126],
                                        [0.9999923717399964, -0.0039059521011293643],
                                        [0.9999938211140119, -0.003515356852062973],
                                        [0.9999951179123994, -0.0031247642097102634],
                                        [0.999996262155962, -0.0027341678997491606],
                                        [0.9999972538295608, -0.002343572771777715],
                                        [0.9999980929345732, -0.0019529790618736484],
                                        [0.9999987794762837, -0.0015623846973456307],
                                        [0.999999313457387, -0.0011717869918159319],
                                        [0.999999694869178, -0.000781192390328727],
                                        [0.9999999237179578, -0.0003905945192233482],
                                       [1.0, 0.0]]

        # Initial past base velocities manually retrieved from a standing pose
        initial_past_trajectory_base_vel = [[0.0026596026673994097, -0.0036648600695725142],
                                    [0.0026610339452683906, -0.003663820959069162],
                                    [0.0026624618469103353, -0.0036627708065018845],
                                    [0.0026638952851042526, -0.0036617410596578807],
                                    [0.0026653254955963652, -0.003660689836623215],
                                    [0.0026667550716268367, -0.003659653708431181],
                                    [0.0026681811158322005, -0.003658616979253869],
                                    [0.002669616214903244, -0.0036575745998335073],
                                    [0.0026710509070692248, -0.0036565316572672855],
                                    [0.00267246954438113, -0.0036554879581719886],
                                    [0.0026738972878064464, -0.0036544333858607716],
                                    [0.0026753244934117526, -0.0036533886916647177],
                                    [0.0026767511738523863, -0.003652353875415824],
                                    [0.0026781776799157907, -0.0036512976312858153],
                                    [0.002679616178485772, -0.003650251396067544],
                                    [0.0026810261025279327, -0.0036492043111861438],
                                    [0.0026824668620947442, -0.0036481622020557683],
                                    [0.002683879098004333, -0.0036471140460612194],
                                    [0.002685312832378327, -0.0036460655370843115],
                                    [0.0026867273789002856, -0.00364501630574531],
                                    [0.0026881603360259347, -0.0036439614591838782],
                                    [0.002689586538764857, -0.00364291643731224],
                                    [0.0026910092820887346, -0.003641860398506238],
                                    [0.0026924221129044816, -0.003640819393236157],
                                    [0.0026938439971073334, -0.003639767466126147],
                                    [0.002695268663612408, -0.003638704567407736],
                                    [0.002696689721876551, -0.0036376515283696865],
                                    [0.0026981009249859673, -0.0036366083190739903],
                                    [0.002699521191342563, -0.0036355489551039145],
                                    [0.0027009441479402046, -0.0036344942684490705],
                                    [0.002702366670581848, -0.0036334442428568987],
                                    [0.002703779416296505, -0.0036323884065143142],
                                    [0.0027051980439246415, -0.003631321606572732],
                                    [0.0027066193482793745, -0.003630264698469278],
                                    [0.002708037110378657, -0.0036292072255858475],
                                    [0.0027094638492328217, -0.0036281492193542698],
                                    [0.0027108713957011837, -0.0036270906183057537],
                                    [0.00271228165806409, -0.0036260314759179227],
                                    [0.0027137040246006613, -0.003624971799103914],
                                    [0.0027151228439162086, -0.0036239167802755035],
                                    [0.002716531865543588, -0.0036228612023171043],
                                    [0.002717952993942073, -0.003621799857935674],
                                    [0.0027193737078339475, -0.0036207379559828126],
                                    [0.002720775219705167, -0.003619665077193461],
                                    [0.00272219510617805, -0.0036186072862108534],
                                    [0.00272361144244023, -0.0036175437258978145],
                                    [0.002725027353731481, -0.003616474392224524],
                                    [0.0027264366238392225, -0.0036154201740137624],
                                    [0.0027278548303872976, -0.0036143497261717085],
                                    [0.0027292570019628926, -0.003613289208665431],
                                    [0.0027306743709001454, -0.003612217655202784]]

    elif robot == "iCubV3":

        # Initial past base positions manually retrieved from a standing pose
        initial_past_trajectory_base_pos = [[0.00028858053745913994, -0.004310564981545039],
                                            [0.00028858053745913994, -0.004310564981545039],
                                            [0.00014029534305181737, -0.004444469552370873],
                                            [0.00010981816808943033, -0.004190943132520633],
                                            [0.0001779119851947002, -0.0066178617822220745],
                                            [-2.0685679014229374e-05, -0.006181066152613343],
                                            [-5.200917978784535e-05, -0.005889517495894617],
                                            [-0.0001712153091906801, -0.005786529913896019],
                                            [-0.0003847572294725188, -0.005891372060199507],
                                            [-0.00034830450256651414, -0.0057304422836444895],
                                            [-0.00028813457775032046, -0.005489687003431531],
                                            [-0.0002881345777504161, -0.005489687003431655],
                                            [-0.00030635821192532067, -0.005286799158239061],
                                            [-0.00022450549875523737, -0.005096906433504698],
                                            [-0.0001346668499750847, -0.004997606672340549],
                                            [-3.592553352546754e-05, -0.004889828674273758],
                                            [1.0357834253969687e-05, -0.004764026492533565],
                                            [0.00017350102627003322, -0.004419091908533919],
                                            [0.00017350102627004775, -0.004419091908534029],
                                            [0.00019083134355446334, -0.004275037014184497],
                                            [0.0001677679088474318, -0.004207090317285843],
                                            [0.0001386224398644491, -0.0037192730165934535],
                                            [0.00016243600653582262, -0.0035395465077736666],
                                            [0.00014903420515039096, -0.0034178760951885027],
                                            [0.00014466608792459328, -0.003230792789160716],
                                            [8.062722690651277e-05, -0.0031404102878970267],
                                            [7.590773532493793e-05, -0.003018065127631289],
                                            [7.653439226120078e-05, -0.00273397669963368],
                                            [7.653439226128184e-05, -0.0027339766996334453],
                                            [-2.1757928516099703e-05, -0.0023161268801821394],
                                            [-1.8485483531893263e-05, -0.002217476473677838],
                                            [-1.0425371656553609e-05, -0.0021228453800541066],
                                            [-1.0885463898120116e-05, -0.002036249103718222],
                                            [3.5073806182924916e-05, -0.0018483673365711252],
                                            [4.0801065781144134e-05, -0.001650062635591626],
                                            [4.0801065781144134e-05, -0.001650062635591626],
                                            [7.949209449184907e-06, -0.0013893827380300617],
                                            [4.263952842106295e-05, -0.0013109523074692473],
                                            [4.263952842106295e-05, -0.0013109523074692473],
                                            [2.2696152154906348e-05, -0.0010498097510761716],
                                            [1.9997796202443554e-05, -0.0009560564076650197],
                                            [-7.917038448472608e-05, -0.0007946696888053274],
                                            [-7.917038448483616e-05, -0.0007946696888053419],
                                            [-9.312534443387187e-05, -0.0004696637113924691],
                                            [-9.312534443387187e-05, -0.0004696637113924691],
                                            [-8.138668293464748e-05, -0.0003802511036554848],
                                            [-5.0407867678011316e-05, -0.0002029244373028354],
                                            [-3.195365523516142e-05, -0.00010030332591467547],
                                            [0.0, 0.0],
                                            [0.0, 0.0],
                                            [0.0, 0.0]]

        # Initial past facing directions manually retrieved from a standing pose
        initial_past_trajectory_facing_dirs = [[0.9999877230809147, -0.004955167751728995],
                                               [0.9999877230809147, -0.004955167751728995],
                                               [0.9999997461922917, -0.0007124712991541938],
                                               [0.9999970041190025, 0.002447805756073182],
                                               [0.9999917690382489, 0.004057321253381992],
                                               [0.9999727712359794, 0.007379484171362656],
                                               [0.9999562921616334, 0.009349532948638942],
                                               [0.9999376317783504, 0.011168372912102462],
                                               [0.9999180426010426, 0.012802659133924043],
                                               [0.9998649545166384, 0.016433889662537414],
                                               [0.9998524721016931, 0.017176554722433863],
                                               [0.9998493091465936, 0.01735969467125785],
                                               [0.9998493091465936, 0.01735969467125785],
                                               [0.9998623783750882, 0.01658988577754625],
                                               [0.9998906848534431, 0.014785747979468166],
                                               [0.999901939380655, 0.01400398596132014],
                                               [0.9999125755768462, 0.013222753241203688],
                                               [0.9999231098591682, 0.012400579404588408],
                                               [0.9999545258104788, 0.00953657753809313],
                                               [0.9999545258104788, 0.00953657753809313],
                                               [0.9999636579683457, 0.008525417442281625],
                                               [0.9999712309923894, 0.007585327123149438],
                                               [0.9999887807854961, 0.004736908605480272],
                                               [0.9999927829787209, 0.0037992091904469182],
                                               [0.9999956394609861, 0.0029531439201921873],
                                               [0.9999979886329197, 0.00200567447875282],
                                               [0.999999571917384, 0.0009252918721637427],
                                               [0.9999999921626754, 0.0001251984387432272],
                                               [0.9999993224203368, -0.0011641129098839875],
                                               [0.9999993224203368, -0.0011641129098839875],
                                               [0.9999977302454371, -0.0021306111737428553],
                                               [0.999997174182357, -0.0023773151454237603],
                                               [0.9999967924739566, -0.0025327932798238028],
                                               [0.9999967269649005, -0.0025585268194898165],
                                               [0.9999969574980739, -0.0024667781811591317],
                                               [0.9999975832059065, -0.0021985409584420533],
                                               [0.9999975832059065, -0.0021985409584420533],
                                               [0.9999980503667544, -0.0019746550812874217],
                                               [0.9999983563117862, -0.0018131116142379457],
                                               [0.9999983563117862, -0.0018131116142379457],
                                               [0.9999994737798293, -0.0010258850151287206],
                                               [0.9999996952095942, -0.0007807565039727822],
                                               [0.9999999166613645, -0.0004082612693219778],
                                               [0.9999999166613645, -0.0004082612693219778],
                                               [0.9999999972156045, 7.46243307523612e-05],
                                               [0.9999999972156045, 7.46243307523612e-05],
                                               [0.9999999979943799, 6.333434973323386e-05],
                                               [0.999999997561708, 6.983254109599897e-05],
                                               [0.9999999992829202, -3.7870297342235443e-05],
                                               [0.9999999999999998, -1.361153309628759e-16],
                                               [0.9999999999999998, -1.361153309628759e-16]]

        # Initial past base velocities manually retrieved from a standing pose
        initial_past_trajectory_base_vel = [[0.0, 0.0],
                                            [-0.0074142597203661256, -0.006695228541291729],
                                            [-0.0015238587481193554, 0.01267632099251202],
                                            [0.007215423654988083, -0.0552058199440744],
                                            [-0.003810732799724586, -0.06614011254099765],
                                            [-0.009929883210446482, 0.02183978148043658],
                                            [-0.001566175038680797, 0.014577432835936233],
                                            [-0.00596030647014174, 0.005149379099929926],
                                            [-0.010677096014091933, -0.005242107315174342],
                                            [0.0018226363453002334, 0.008046488827750846],
                                            [0.00300849624080968, 0.012037764010647935],
                                            [-4.778326531661816e-15, -6.2287521846039355e-15],
                                            [-0.0009111817087452315, 0.010144392259629731],
                                            [0.004092635658504164, 0.009494636236718125],
                                            [0.004491932439007638, 0.004964988058207477],
                                            [0.004937065822480855, 0.00538889990333952],
                                            [0.002314168388971864, 0.006290109087009623],
                                            [0.008157159600803173, 0.017246729199982342],
                                            [7.252128264710591e-16, -5.503539358132876e-15],
                                            [0.0008665158642207827, 0.007202744717476617],
                                            [-0.0011531717353515793, 0.0033973348449326856],
                                            [-0.0014572734491491348, 0.024390865034619482],
                                            [0.0011906783335686763, 0.008986325440989342],
                                            [-0.0006700900692715831, 0.006083520629258199],
                                            [-0.0002184058612898849, 0.009354165301389324],
                                            [-0.003201943050904025, 0.004519125063184484],
                                            [-0.0002359745790787405, 0.006117258013286872],
                                            [3.1332846813140874e-05, 0.014204421399880455],
                                            [4.053113705190757e-15, 1.1732291542736811e-14],
                                            [-0.004914616038869077, 0.0208924909725653],
                                            [0.00016362224921032155, 0.004932520325215053],
                                            [0.0004030055937669828, 0.004731554681186592],
                                            [-2.300461207832554e-05, 0.004329813816794222],
                                            [0.0022979635040522523, 0.009394088357354847],
                                            [0.00028636297991096196, 0.009915235048974957],
                                            [0.0, 0.0],
                                            [-0.001642592816597962, 0.013033994878078208],
                                            [0.0017345159485939023, 0.003921521528040723],
                                            [0.0, 0.0],
                                            [-0.0009971688133078298, 0.013057127819653786],
                                            [-0.00013491779762314063, 0.0046876671705576],
                                            [-0.004958409034358482, 0.008069335942984616],
                                            [-5.5035393581328755e-15, -7.252128264710591e-16],
                                            [-0.0006977479974517856, 0.016250298870643633],
                                            [0.0, 0.0],
                                            [0.0005869330749612197, 0.0044706303868492165],
                                            [0.001548940762831808, 0.00886633331763247],
                                            [0.0009227106221424945, 0.005131055569407997],
                                            [0.0015976827617580711, 0.005015166295733774],
                                            [-0.0017834898327718184, 0.005122341648658002],
                                            [0.0, 0.0]]

    else:
        raise Exception("Initial past trajectory data only defined for iCubV2_5 and iCubV3.")

    return initial_past_trajectory_base_pos, initial_past_trajectory_facing_dirs, initial_past_trajectory_base_vel

def define_initial_base_height(robot: str) -> List:
    """Define the robot-specific initial height of the base frame."""

    if robot == "iCubV2_5":
        initial_base_height = 0.6354

    elif robot == "iCubV3":
        initial_base_height = 0.628

    else:
        raise Exception("Initial base height only defined for iCubV2_5 and iCubV3.")

    return initial_base_height

def define_initial_base_yaw(robot: str) -> List:
    """Define the robot-specific initial base yaw expressed in the world frame."""

    if robot == "iCubV2_5":
        # For iCubV2_5, the initial base yaw is 180 degs since the x axis of the base frame points backward
        initial_base_yaw = math.pi

    elif robot == "iCubV3":
        # For iCubV3, the initial base yaw is 0 degs since the x axis of the base frame points forward
        initial_base_yaw = 0

    else:
        raise Exception("Initial base yaw only defined for iCubV2_5 and iCubV3.")

    return initial_base_yaw

def trajectory_blending(a0: List, a1: List, t: np.array, tau: float) -> List:
    """Blend the vectors a0 and a1 via:
           Blend(a0, a1, t, tau) = (1 - t^tau) a0 + t^tau a1
       Increasing tau means biasing more towards a1.
    """

    blended_trajectory = []

    for i in range(len(t)):
        p_i = (1 - math.pow(t[i], tau)) * np.array(a0[i]) + math.pow(t[i], tau) * np.array(a1[i])
        blended_trajectory.append(p_i.tolist())

    return blended_trajectory

def load_component_wise_input_mean_and_std(datapath: str) -> (Dict, Dict):
    """Compute component-wise input mean and standard deviation."""

    # Full-input mean and std
    Xmean = read_from_file(datapath + 'X_mean.txt')
    Xstd = read_from_file(datapath + 'X_std.txt')

    # Remove zeroes from Xstd
    for i in range(Xstd.size):
        if Xstd[i] == 0:
            Xstd[i] = 1

    # Retrieve component-wise input mean and std (used to normalize the next input for the network)
    Xmean_dict = {"past_base_positions": Xmean[0:12]}
    Xstd_dict = {"past_base_positions": Xstd[0:12]}
    Xmean_dict["future_base_positions"] = Xmean[12:24]
    Xstd_dict["future_base_positions"] = Xstd[12:24]
    Xmean_dict["past_facing_directions"] = Xmean[24:36]
    Xstd_dict["past_facing_directions"] = Xstd[24:36]
    Xmean_dict["future_facing_directions"] = Xmean[36:48]
    Xstd_dict["future_facing_directions"] = Xstd[36:48]
    Xmean_dict["past_base_velocities"] = Xmean[48:60]
    Xstd_dict["past_base_velocities"] = Xstd[48:60]
    Xmean_dict["future_base_velocities"] = Xmean[60:72]
    Xstd_dict["future_base_velocities"] = Xstd[60:72]
    Xmean_dict["future_traj_length"] = Xmean[72]
    Xstd_dict["future_traj_length"] = Xstd[72]
    Xmean_dict["s"] = Xmean[73:105]
    Xstd_dict["s"] = Xstd[73:105]
    Xmean_dict["s_dot"] = Xmean[105:]
    Xstd_dict["s_dot"] = Xstd[105:]

    return Xmean_dict, Xstd_dict

def load_output_mean_and_std(datapath: str) -> (List, List):
    """Compute output mean and standard deviation."""

    # Full-output mean and std
    Ymean = read_from_file(datapath + 'Y_mean.txt')
    Ystd = read_from_file(datapath + 'Y_std.txt')

    # Remove zeroes from Ystd
    for i in range(Ystd.size):
        if Ystd[i] == 0:
            Ystd[i] = 1

    return Ymean, Ystd

# ===================
# VISUALIZATION UTILS
# ===================

def visualize_generated_motion(icub: iCub,
                               gazebo: scenario.GazeboSimulator,
                               posturals: Dict,
                               raw_data: List,
                               blending_coeffs: Dict,
                               plot_blending_coeffs: bool) -> None:
    """Visualize the generated motion along with the joystick inputs used to generate it and,
    optionally, the activations of the blending coefficients during the trajectory generation."""

    # Retrieve joint and base posturals
    joint_posturals = posturals["joints"]
    base_posturals = posturals["base"]

    # Retrieve blending coefficients
    if plot_blending_coeffs:
        w_1 = blending_coeffs["w_1"]
        w_2 = blending_coeffs["w_2"]
        w_3 = blending_coeffs["w_3"]
        w_4 = blending_coeffs["w_4"]

    # Define controlled joints
    controlled_joints = icub.joint_names()

    # Plot configuration
    plt.ion()

    for frame_idx in range(len(joint_posturals)):

        # Debug
        print(frame_idx, "/", len(joint_posturals))

        # ======================
        # VISUALIZE ROBOT MOTION
        # ======================

        # Retrieve the current joint positions
        joint_postural = joint_posturals[frame_idx]
        joint_positions = [joint_postural[joint] for joint in controlled_joints]

        # Retrieve the current base position and orientation
        base_postural = base_posturals[frame_idx]
        base_position = base_postural['postion']
        base_quaternion = base_postural['wxyz_quaternions']

        # Reset the robot configuration in the simulator
        icub.to_gazebo().reset_base_pose(base_position, base_quaternion)
        icub.to_gazebo().reset_joint_positions(joint_positions, controlled_joints)
        gazebo.run(paused=True)

        # =====================================
        # PLOT THE MOTION DIRECTION ON FIGURE 1
        # =====================================

        # Retrieve the current motion direction
        curr_raw_data = raw_data[frame_idx]
        curr_x = curr_raw_data[0]
        curr_y = curr_raw_data[1]

        plt.figure(1)
        plt.clf()

        # Circumference of unitary radius
        r = 1
        x = np.linspace(-r, r, 1000)
        y = np.sqrt(-x ** 2 + r ** 2)
        plt.plot(x, y, 'r')
        plt.plot(x, -y, 'r')

        # Motion direction
        plt.scatter(0, 0, c='r')
        desired_motion_direction = plt.arrow(0, 0, curr_x, -curr_y, length_includes_head=True, width=0.01,
                                             head_width=8 * 0.01, head_length=1.8 * 8 * 0.01, color='r')

        # Plot configuration
        plt.axis('scaled')
        plt.xlim([-1.2, 1.2])
        plt.ylim([-1.4, 1.2])
        plt.axis('off')
        plt.legend([desired_motion_direction], ['DESIRED MOTION DIRECTION'], loc="lower center")

        # =====================================
        # PLOT THE FACING DIRECTION ON FIGURE 2
        # =====================================

        # Retrieve the current facing direction
        curr_z = curr_raw_data[2]
        curr_rz = curr_raw_data[3]

        plt.figure(2)
        plt.clf()

        # Circumference of unitary norm
        r = 1
        x = np.linspace(-r, r, 1000)
        y = np.sqrt(-x ** 2 + r ** 2)
        plt.plot(x, y, 'b')
        plt.plot(x, -y, 'b')

        # Facing direction
        plt.scatter(0, 0, c='b')
        desired_facing_direction = plt.arrow(0, 0, curr_z, -curr_rz, length_includes_head=True, width=0.01,
                                             head_width=8 * 0.01, head_length=1.8 * 8 * 0.01, color='b')

        # Plot configuration
        plt.axis('scaled')
        plt.xlim([-1.2, 1.2])
        plt.ylim([-1.4, 1.2])
        plt.axis('off')
        plt.legend([desired_facing_direction], ['DESIRED FACING DIRECTION'], loc="lower center")

        # ==========================================
        # PLOT THE BLENDING COEFFICIENTS ON FIGURE 3
        # ==========================================

        if plot_blending_coeffs:
            # Retrieve the blending coefficients up to the current time
            curr_w_1 = w_1[:frame_idx]
            curr_w_2 = w_2[:frame_idx]
            curr_w_3 = w_3[:frame_idx]
            curr_w_4 = w_4[:frame_idx]

            plt.figure(3)
            plt.clf()

            plt.plot(range(len(curr_w_1)), curr_w_1, 'r')
            plt.plot(range(len(curr_w_2)), curr_w_2, 'b')
            plt.plot(range(len(curr_w_3)), curr_w_3, 'g')
            plt.plot(range(len(curr_w_4)), curr_w_4, 'y')

            # Plot configuration
            plt.title("Blending coefficients profiles")
            plt.xlim([0, len(w_1)])
            plt.ylabel("Blending coefficients")
            plt.xlabel("Time [s]")

        # Plot
        plt.show()
        plt.pause(0.0001)

    input("Press Enter to end the visualization of the generated trajectory.")
