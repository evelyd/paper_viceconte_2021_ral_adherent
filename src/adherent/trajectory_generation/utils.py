# SPDX-FileCopyrightText: Fondazione Istituto Italiano di Tecnologia
# SPDX-License-Identifier: BSD-3-Clause

import math
import time
import numpy as np
from scenario import core
from typing import List, Dict
from dataclasses import dataclass
from gym_ignition.utils import misc
from scenario import gazebo as scenario
from adherent.MANN.utils import read_from_file
from adherent.data_processing.utils import iCub

import matplotlib as mpl
mpl.rcParams['toolbar'] = 'None'
import matplotlib.pyplot as plt

# =====================
# MODEL INSERTION UTILS
# =====================

@dataclass
class SphereURDF:
    """Class for defining a sphere urdf with parametric radius and color."""

    radius: float = 0.5
    color: tuple = (1, 1, 1, 1)

    def urdf(self) -> str:
        i = 2.0 / 5 * 1.0 * self.radius * self.radius
        urdf = f"""
            <robot name="sphere_robot" xmlns:xacro="http://www.ros.org/wiki/xacro">

                <!-- ====== -->
                <!-- COLORS -->
                <!-- ====== -->
                <material name="custom">
                    <color rgba="{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}"/>
                </material>
                <gazebo reference="sphere">
                    <visual>
                      <material>
                        <diffuse>{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}</diffuse>
                      </material>
                    </visual>
                    <collision>
                        <surface>
                          <friction>
                            <ode>
                              <mu>0.0</mu>
                            </ode>
                          </friction>
                        </surface>
                    </collision>
                </gazebo>

                <!-- ===== -->
                <!-- LINKS -->
                <!-- ===== -->

                <link name="sphere">
                    <inertial>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                      <mass value="1.0"/>
                      <inertia ixx="{i}" ixy="0" ixz="0" iyy="{i}" iyz="0" izz="{i}"/>
                    </inertial>
                    <visual>
                      <geometry>
                        <sphere radius="{self.radius}"/>
                      </geometry>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                      <material name="custom">
                        <color rgba="{self.color[0]} {self.color[1]} {self.color[2]} {self.color[3]}"/>
                      </material>
                    </visual>
                    <collision>
                      <geometry>
                        <sphere radius="{self.radius}"/>
                      </geometry>
                      <origin rpy="0 0 0" xyz="0 0 0"/>
                    </collision>
                </link>
                <gazebo reference="sphere">
                  <collision>
                    <surface>
                      <friction>
                        <ode>
                          <mu>0.0</mu>
                          <mu2>0.0</mu2>
                        </ode>
                      </friction>
                    </surface>
                  </collision>
                </gazebo>
            </robot>"""

        return urdf

class Shape:
    """Helper class to simplify shape insertion."""

    def __init__(self,
                 world: scenario.World,
                 position: List[float] = (0, 0, 0),
                 orientation: List[float] = (1, 0, 0, 0),
                 model_string: str = SphereURDF(radius=0.02).urdf()):
        self.sdf = misc.string_to_file(model_string)

        # Assing incremental default name when multiple shapes are inserted
        name = scenario.get_model_name_from_sdf(self.sdf)
        index = 0
        while name in world.model_names():
            name = f"{name}{index}"

        # Insert the shape in the world
        assert world.insert_model(self.sdf, core.Pose(position, orientation), name)

        # Get and store the model and the world
        self.model = world.get_model(model_name=name)
        self.world = world

# =====================
# JOYSTICK DEVICE UTILS
# =====================

def quadratic_bezier(p0: np.array, p1: np.array, p2: np.array, t: np.array) -> List:
    """Define a discrete quadratic Bezier curve. Given the initial point p0, the control point p1 and
       the final point p2, the quadratic Bezier consists of t points and is defined by:
               Bezier(p0, p1, p2, t) = (1 - t)^2 p0 + 2t (1 - t) p1 + t^2 p2
    """

    quadratic_bezier = []

    for t_i in t:
        p_i = (1 - t_i) * (1 - t_i) * p0 + 2 * t_i * (1 - t_i) * p1 + t_i * t_i * p2
        quadratic_bezier.append(p_i)

    return quadratic_bezier

def compute_angle_wrt_x_positive_semiaxis(current_base_direction: List) -> float:
    """Compute the angle between the current base direction and the x positive semiaxis."""

    # Define the x positive semiaxis
    x_positive_semiaxis = np.asarray([1, 0])

    # Compute the yaw between the current base direction and the world x axis
    cos_theta = np.dot(x_positive_semiaxis, current_base_direction) # unitary norm vectors
    sin_theta = np.cross(x_positive_semiaxis, current_base_direction) # unitary norm vectors
    angle = math.atan2(sin_theta, cos_theta)

    return angle

# ===========================
# TRAJECTORY GENERATION UTILS
# ===========================

def define_initial_nn_X(robot: str) -> List:
    """Define the robot-specific initial input X for the network used for trajectory generation."""

    if robot == "iCubV2_5":
        # Initial input manually retrieved from a standing pose
        initial_nn_X = [[3.5243694266353373e-15, 7.008199078189101e-15, 3.0614383132617574e-16, 0.012421162571032856,
                     -0.014122548398467332, -0.0017588395790161734, 0.0044019864826900425, -0.0032526431671412843,
                     -0.0003791446290885935, 0.0018464051771702283, -0.0007014617207248446, -0.0002852708574057455,
                     -0.007666416570001765, -0.006401494346322381, -0.0020622161550935647, -0.0019045289643069853,
                     -0.008158728689814406, 0.0006715067872605493, 0.0007060098803055911, -0.01477829078637679, 
                     0.0011823591653468393, -0.0003210022438017331, 6.757567991447852e-06, 0.003540728250141397, 
                     0.0, 0.0, 0.0, 0.017893397271105622, -0.03658355242181092, 0.006983540281113693,
                     0.09451721426339721, -0.009889970586401762, 0.008193869415440216, 0.2053173727694591, 
                     0.07173449613753384, 0.009762607489653094, 1.2839528469302477e-16, 1.9898256768176927e-17, 
                     6.762609578082937e-18, 0.031449943566089156, 0.07414012486813136, 0.07208904404786341, 
                     0.006826734024380377, 0.050238738599215724, 0.0016967450914463823, 0.004713732379144265, 
                     0.019225556089882915, -0.008454823733790681, 0.019126096353924676, -0.03700523273782162, 
                     0.02385417785340806, 0.007936443095453556, -0.005759098538862559, 0.016742656763119815, 
                     0.00818785217095963, -0.037435052638151126, -0.016759287151117987, 0.05256457282727177, 
                     -0.03841732944090507, -0.10431413289643675, 0.0, 0.0, 0.0, 0.0878491471703012,
                     -0.12733981016516405, -0.2832203614502011, 0.03918120592226204, 0.0804221698146093,
                     -0.43534358315740246, -0.09585916148288552, 0.15195461008141126, -0.6545870342808059, 
                     -0.08914329577232137, 0.025767620112200747, 0.016600125582731447, -0.10205569019576242, 
                     -0.10115357046332556, -0.02590094449134414, -0.10954097755732813, -0.021888724926318617, 
                     0.06819316643211669, -0.07852679097651347, -0.10034170556770548, 0.020710812052444683, 
                     0.2413038455611485, 0.010535350226309968, 0.006275324178053386, -0.14908520025814864, 
                     0.08533421586871431, 0.10281322318047023, 0.32297257397277707, 0.14790247588361516, 
                     -0.3129451427487485, 0.04242320961879248, 0.0022412263648723028, -0.016729676987423055, 
                     0.11047971812597632, -0.12993538373842523, 0.018668904587540704, 0.033567343049341246, 
                     0.3631242921725555, -0.28302209132906536, -0.3129451427487485, 0.04242320961879248, 
                     0.018265725998252436, -0.0035976586400216642, -0.012043915220395253, -0.010850374465225243, 
                     -0.0029826472872050702, 0.01194233827184095, 0.00894458674770629, 0.003558151484858718, 
                     0.01579702497265592, -0.0028171693990643176, -0.001904114327552775, -0.011985210234407781, 
                     0.020805414325628102, 0.011839621139096701, 0.009719580928183296, 0.01040432230648286, 
                     0.03174781826678491, -0.07732321906598477, -0.051694399002594205, 0.015153131453655988, 
                     8.599305395817769e-05, -1.1664542210951256e-05, 0.005543033652851423, 0.0010366246463409945, 
                     -0.01100933606651422, -0.041149377276150645, -0.0024410871334947654, -0.04243541029015849, 
                     0.01042528371749396, 0.0009363820684421542, 8.599305395817769e-05, -1.1664542210951256e-05]]

    elif robot == "iCubV3": #TODO measure new values for icub 3

        initial_nn_X = [[# Ground base positions (24)
                         0.2093153153400746, 0.0007977258046139854, 0.20609005222050145, 0.000986745220701998,
                         0.20314241555829549, 0.0008129984700562595, 0.20310428485458668, 0.0005334708703526953,
                         0.2069084791909314, 0.000273665059910764, 0.0, 0.0,
                         -0.2232472422836446, 0.016906553732686336, -0.23763955736491932, 0.012247954960142877,
                         -0.2396347171984989, 0.00640033527663368, -0.2346223666143804, 0.00024074823588101713,
                         -0.22949946077789177, -0.0012381187163133316, -0.23020818968443318, 0.000289829887801336,
                         # Ground facing directions (24)
                         0.4957269963196282, -0.0012373414453218808, 0.49478489563771977, -0.00030618142304097214,
                         0.498917645612757, 0.00014946523320548, 0.5032967472677263, 0.00030523234414608826,
                         0.5027608103982335, 0.00029218554773757685, 0.0, 0.00037114062722229965,
                         0.5197881421653958, -0.03483698885704967, 0.5222422003927134, -0.02406628010420433,
                         0.5089169241056959, -0.010965762377245005, 0.4983727031505572, -0.004621132913015527,
                         0.4955035716197332, -0.002032639311416869, 0.5039252645645284, -3.2656064377950355e-07,
                         # Ground base velocities (24)
                         -0.1495995135503391, 0.02664815778662963, -0.1533939683533026, 0.024935301731629254,
                         -0.14722520333253958, 0.02381322536104677, -0.14133079656110978, 0.02354708668948459,
                         -0.14698575936317768, 0.024022722746152348, -0.16189584842751786, 0.024886327367676302,
                         -0.17773365860597093, 0.016890954491782868, -0.2053345150151419, 0.0022135223446622995,
                         -0.17169688282147774, 0.0005774460958900006, -0.14953259567078525, -0.004232617394607505,
                         -0.14436647996928303, -0.004744691775328756, -0.16214723496767933, 0.00020944288948280176,
                         # Future ground trajectory length (1)
                         -2.412285224951282,
                         # Joint positions (32)
                         -1.0755597, -0.38072908, 0.41070947, 0.7459638, 0.33761653, 0.37217963, -1.0772338, -0.31763422,
                         0.44147602, 0.72504324, 0.30771258, 0.34325337, 0.027976118, -1.0567205, 0.04823284, -0.30169612,
                         -0.09575394, -0.22050153, -0.6913654, 0.7512089, -0.7928649, 1.1334503, 0.82532954, 0.018325701,
                         -0.027246535, -0.29481077, -0.05080641, -0.21277831, -0.6838456, 0.99157274, -0.792865, 0.00068516296,
                         # Joint velocities (32)
                         -0.049030505, -0.019967757, 0.026781108, 0.02506639, 0.0011034012, 0.015805595, -0.017600976, 0.016947683,
                         -0.027080724, 0.0019890442, -0.0065035895, -0.01337162, 0.016774062, -0.12414518, 0.013281074, 0.08456575,
                         -0.000790366, -0.010725047, -0.010401212, 0.06744893, -0.018103538, -0.013881947, -0.052590154, -0.02402312,
                         0.04546096, 0.09769335, 0.011065381, -0.027385615, -0.053893577, 0.051078804, -0.018103553, 0.00068191683]]

    elif robot == "ergoCubV1": #TODO measure new values for ergocub

        initial_nn_X = [[# Ground base positions (24)
            0.21128518720745135, -0.0003572056067718585, 0.2088658883841278, -0.00034024521482042954,
            0.20644710182499512, -0.0003364483236167183, 0.20640875224088917, -0.00034136657652069605,
            0.2096609349095737, -0.000356564853683511, 0.0, 0.0,
            -0.16825399617790562, 0.07614920661022927, -0.18961672974229898, 0.06884770750462543,
            -0.20457559912133022, 0.06553332107044893, -0.2101141267582058, 0.04617846020028273,
            -0.2140235920295574, 0.019389662611891588, -0.22864370874296483, 0.000645064549267912,
            # Ground facing directions (24)
            0.49421503485261814, -7.474033173356468e-06, 0.4907375950986435, 1.200931888545701e-06,
            0.49187609720610387, 3.0742134806110287e-06, 0.4942969325931885, 2.543147662440245e-06,
            0.49394716821561524, 1.574834291440314e-06, 0.0, 0.0020754249732434908,
            0.5024444876409392, 0.028779238757151115, 0.5029992972752538, 0.019526862550413162,
            0.4983492288209324, 0.019636224776018757, 0.4888121068481598, 0.013195196583888624,
            0.49402566859644387, 0.005189257508524113, 0.5035276727921664, 1.3399798393512078e-08,
            # Ground base velocities (24)
            -0.0772792054364139, 0.06054340157727389, -0.08143752805418043, 0.061053961389077455,
            -0.0761046112325597, 0.0608428630544653, -0.07113101416823178, 0.06099397551075746,
            -0.07725585771411402, 0.061953896014374135, -0.09161657865294676, 0.06349967874247876,
            -0.1580969710426519, 0.05522840746388469, -0.15743274870598917, 0.05264662324871108,
            -0.15644003761923206, 0.04138927951834934, -0.1349605334206728, 0.0014044546574461239,
            -0.13516189849665416, 0.003879830585824317, -0.1607691907814692, 0.0003710887323113083,
            # Future ground trajectory length (1)
            -2.3904565665803776,
            # Joint positions (32)
            -0.9549509286880493, -0.6067436933517456, 0.200192391872406, 0.6129438281059265,
            0.2816983163356781, 0.6357421278953552, -1.0493018627166748, -0.2247631847858429,
            0.6858733892440796, 0.6572356224060059, 0.3113216757774353, 0.23262757062911987,
            -1.3949187994003296, 0.04973293095827103, -0.17285868525505066, -0.5520496368408203,
            -0.29277166724205017, 0.4179588556289673, 0.7674448490142822, -0.8442645072937012,
            0.6558106541633606, -0.5899389982223511, -0.0012892420636489987, -0.0679861530661583,
            -0.006543738301843405, 0.3328098654747009, -0.7529277801513672, 0.5614517331123352,
            -0.7080718278884888, -0.0048284404911100864, -0.06798660755157471, -0.0033515982795506716,
            # Joint velocities (32)
            -0.04992648586630821, -0.05410560965538025, 0.027866501361131668, -0.013220880180597305,
            -0.04382770508527756, 0.042030759155750275, -0.015345100313425064, 0.044317491352558136,
            -0.02134034037590027, 0.012074774131178856, 0.010898662731051445, -0.036586299538612366,
            -0.2168498933315277, 0.05936829373240471, -0.01727639138698578, -0.06260577589273453,
            -0.05614761263132095, 0.08311410993337631, 0.08730645477771759, 0.05604230985045433,
            -0.06666574627161026, -0.3099804222583771, -0.012304517440497875, -0.11718892306089401,
            -0.010440457612276077, 0.13503974676132202, -0.05538368970155716, -0.05019628256559372,
            -0.38746196031570435, -0.0032107762526720762, -0.1171911433339119, 0.00997149758040905]]

    else:
        raise Exception("Initial network input X only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return initial_nn_X

def define_initial_past_trajectory(robot: str) -> (List, List, List):
    """Define the robot-specific initialization of the past trajectory data used for trajectory generation."""

    # The above quantities are expressed in the frame specified by the initial base position and the facing direction

    if robot == "iCubV2_5":

      # Initial past base linear velocities manually retrieved from a standing pose
      initial_past_trajectory_base_vel = [[-0.00716343,  0.00385182,  0.00026315],
                                        [ 3.83626058e-15,  7.09872475e-15, -5.22836963e-15], 
                                        [-0.00675958,  0.00449099,  0.00059273], 
                                        [-0.00722386,  0.00551062,  0.00051982], 
                                        [-7.03736213e-15,  3.44515696e-15, -4.85989740e-16], 
                                        [-0.00676486,  0.00158084, -0.00026224], 
                                        [-0.00538534,  0.00128945,  0.00017258], 
                                        [-0.00331833,  0.00163447,  0.00042496], 
                                        [-0.00953416,  0.00254862,  0.00044421], 
                                        [-1.80269867e-15,  5.24949718e-15, -8.90842611e-17], 
                                        [-0.01330885,  0.00049532,  0.00115734], 
                                        [4.83036766e-15, 1.75945287e-15, 5.93309633e-15], 
                                        [-0.00349938, -0.00056845,  0.00053368], 
                                        [-0.01246749, -0.00152131,  0.000421  ], 
                                        [-0.00832295,  0.0004091 , -0.00032585], 
                                        [-0.01797435,  0.00017675, -0.00029361], 
                                        [-0.01288769,  0.00301351,  0.00084927], 
                                        [-0.00877806, -0.00043779, -0.00075292], 
                                        [ 1.40747243e-14, -6.89031391e-15,  9.71979480e-16], 
                                        [-0.02340612,  0.00397878, -0.00091494], 
                                        [-6.63306633e-15,  3.49004431e-15, -6.02218059e-15], 
                                        [-0.00865152,  0.00134653, -0.00177219], 
                                        [-0.00786997, -0.00233357, -0.00156049], 
                                        [-0.00892424, -0.00258245, -0.00146873], 
                                        [-0.00811743,  0.00200219, -0.00099574], 
                                        [-0.01302307,  0.00418385, -0.00174521], 
                                        [-0.00462916,  0.00026048, -0.00119211], 
                                        [-0.0050965 , -0.00139854, -0.00160158], 
                                        [-0.005476  , -0.00227114, -0.00200646], 
                                        [-0.01676012, -0.00561986, -0.00489061], 
                                        [ 0.00264328, -0.00101225, -0.00052074], 
                                        [ 5.40809601e-15, -1.57484915e-14,  2.67252783e-16], 
                                        [-0.0027995 , -0.00375919, -0.00231512], 
                                        [ 1.80269867e-15, -5.24949718e-15,  8.90842611e-17], 
                                        [ 0.01081781, -0.00782894, -0.00248261], 
                                        [ 0.00139013, -0.00224276, -0.00093824], 
                                        [-0.00658927, -0.00711429, -0.00251821], 
                                        [-4.97053540e-16,  2.66963594e-15, -5.58073298e-15], 
                                        [ 0.00104704, -0.00982987, -0.00381658], 
                                        [ 0.00307704, -0.00356778, -0.00104486], 
                                        [-0.00066357, -0.00226427, -0.00036987], 
                                        [-0.01301264, -0.00357357, -0.00220798], 
                                        [-0.00417191, -0.00309992, -0.00233419], 
                                        [ 0.00640315, -0.00554543, -0.00296235], 
                                        [ 0.00687916, -0.00118332, -0.00065244], 
                                        [ 0.00819684, -0.00063089, -0.00048392], 
                                        [ 0.00726917, -0.00193537, -0.00091059], 
                                        [ 0.00651411, -0.00352663, -0.00144585], 
                                        [ 0.02139752, -0.00941589, -0.00282025], 
                                        [-3.51263960e-15,  7.78447106e-15,  1.09387553e-14], 
                                        [ 0.00912293, -0.00267039, -0.00048275]]

      # Initial past base angular velocities manually retrieved from a standing pose
      initial_past_trajectory_base_ang_vel = [[-0.00755611, -0.0350876 , -0.0231277 ], 
                                            [0., 0., 0.], [-0.0087613 , -0.03888634, -0.027938  ], 
                                            [-0.0105522 , -0.04917967, -0.00152774], 
                                            [ 2.84504292e-16, -6.17399465e-16,  2.75187740e-15], 
                                            [-0.00168213, -0.04111259, -0.00753031], 
                                            [-0.00309745, -0.03786141, -0.03232349], 
                                            [-0.00704214, -0.02328724, -0.00895122], 
                                            [-0.01365813, -0.05655421,  0.00088823], 
                                            [8.54022144e-17, 1.48861722e-17, 2.82559492e-18], 
                                            [-0.0308838 , -0.07690305,  0.00853956], 
                                            [-1.70797352e-16, -2.97883444e-17, -5.77338249e-18], 
                                            [-0.00905094, -0.02452463, -0.00801273], 
                                            [-0.01191892, -0.07322378, -0.02738323], 
                                            [-0.00200355, -0.0343647 , -0.02822263], 
                                            [-0.00230115, -0.06715387, -0.11565876], 
                                            [-0.01534877, -0.05918849, -0.10457992], 
                                            [ 0.00594433, -0.04117897, -0.04580102], 
                                            [ 2.42486990e-16, -3.43752578e-16, -7.26415095e-15], 
                                            [ 0.00069116, -0.08983208, -0.1398635 ], 
                                            [-7.18915658e-16,  2.69132944e-15, -3.23792190e-17], 
                                            [ 0.01061373, -0.02487456, -0.00066224], 
                                            [ 0.01487274, -0.03206658, -0.02535907], 
                                            [ 0.01293469, -0.03481197, -0.01976739], 
                                            [ 0.00374153, -0.02509881, -0.0024132 ], 
                                            [ 0.00458413, -0.01476757,  0.01782594], 
                                            [ 0.00892151, -0.00587989,  0.01157207], 
                                            [ 0.01427018, -0.01349857,  0.01140695], 
                                            [ 0.02126881, -0.01271533, -0.00112174], 
                                            [ 0.04419007, -0.02972633, -0.01915061], 
                                            [0.00704018, 0.0167406 , 0.01190216], 
                                            [8.54525993e-17, 1.44741001e-17, 3.38442587e-18], 
                                            [ 0.02465543,  0.0231271 , -0.0269139 ], 
                                            [ 3.08885256e-16, -1.71101691e-17, -5.46882732e-15], 
                                            [0.03967082, 0.0946244 , 0.00762483], 
                                            [ 0.01492882,  0.01411408, -0.01669203], 
                                            [ 0.03444098, -0.027689  , -0.05422716], 
                                            [ 1.45933105e-16,  6.63493579e-16, -5.47416306e-15], 
                                            [ 0.05454233,  0.06117371, -0.06128212], 
                                            [ 0.01988478,  0.02682925, -0.02975806], 
                                            [ 0.00822804, -0.01885205, -0.03093768], 
                                            [ 0.0309434 , -0.07454498, -0.11478169], 
                                            [ 0.03355912, -0.00444326, -0.06843284], 
                                            [ 0.0540644 ,  0.03668021, -0.05470951], 
                                            [0.01472837, 0.02494858, 0.01199966], 
                                            [0.01405378, 0.03205797, 0.02029692], 
                                            [0.01825257, 0.03231723, 0.01303322], 
                                            [0.02497076, 0.02872931, 0.00766891], 
                                            [0.05355659, 0.04849043, 0.13106968], 
                                            [1.28251216e-16, 2.13485038e-17, 4.78841635e-18], 
                                            [0.01283283, 0.02187821, 0.07408406]]

    elif robot == "iCubV3": #TODO change all vels, current are for v2.5

      # Initial past base linear velocities manually retrieved from a standing pose
      initial_past_trajectory_base_vel = [[-0.00716343,  0.00385182,  0.00026315],
                                        [ 3.83626058e-15,  7.09872475e-15, -5.22836963e-15], 
                                        [-0.00675958,  0.00449099,  0.00059273], 
                                        [-0.00722386,  0.00551062,  0.00051982], 
                                        [-7.03736213e-15,  3.44515696e-15, -4.85989740e-16], 
                                        [-0.00676486,  0.00158084, -0.00026224], 
                                        [-0.00538534,  0.00128945,  0.00017258], 
                                        [-0.00331833,  0.00163447,  0.00042496], 
                                        [-0.00953416,  0.00254862,  0.00044421], 
                                        [-1.80269867e-15,  5.24949718e-15, -8.90842611e-17], 
                                        [-0.01330885,  0.00049532,  0.00115734], 
                                        [4.83036766e-15, 1.75945287e-15, 5.93309633e-15], 
                                        [-0.00349938, -0.00056845,  0.00053368], 
                                        [-0.01246749, -0.00152131,  0.000421  ], 
                                        [-0.00832295,  0.0004091 , -0.00032585], 
                                        [-0.01797435,  0.00017675, -0.00029361], 
                                        [-0.01288769,  0.00301351,  0.00084927], 
                                        [-0.00877806, -0.00043779, -0.00075292], 
                                        [ 1.40747243e-14, -6.89031391e-15,  9.71979480e-16], 
                                        [-0.02340612,  0.00397878, -0.00091494], 
                                        [-6.63306633e-15,  3.49004431e-15, -6.02218059e-15], 
                                        [-0.00865152,  0.00134653, -0.00177219], 
                                        [-0.00786997, -0.00233357, -0.00156049], 
                                        [-0.00892424, -0.00258245, -0.00146873], 
                                        [-0.00811743,  0.00200219, -0.00099574], 
                                        [-0.01302307,  0.00418385, -0.00174521], 
                                        [-0.00462916,  0.00026048, -0.00119211], 
                                        [-0.0050965 , -0.00139854, -0.00160158], 
                                        [-0.005476  , -0.00227114, -0.00200646], 
                                        [-0.01676012, -0.00561986, -0.00489061], 
                                        [ 0.00264328, -0.00101225, -0.00052074], 
                                        [ 5.40809601e-15, -1.57484915e-14,  2.67252783e-16], 
                                        [-0.0027995 , -0.00375919, -0.00231512], 
                                        [ 1.80269867e-15, -5.24949718e-15,  8.90842611e-17], 
                                        [ 0.01081781, -0.00782894, -0.00248261], 
                                        [ 0.00139013, -0.00224276, -0.00093824], 
                                        [-0.00658927, -0.00711429, -0.00251821], 
                                        [-4.97053540e-16,  2.66963594e-15, -5.58073298e-15], 
                                        [ 0.00104704, -0.00982987, -0.00381658], 
                                        [ 0.00307704, -0.00356778, -0.00104486], 
                                        [-0.00066357, -0.00226427, -0.00036987], 
                                        [-0.01301264, -0.00357357, -0.00220798], 
                                        [-0.00417191, -0.00309992, -0.00233419], 
                                        [ 0.00640315, -0.00554543, -0.00296235], 
                                        [ 0.00687916, -0.00118332, -0.00065244], 
                                        [ 0.00819684, -0.00063089, -0.00048392], 
                                        [ 0.00726917, -0.00193537, -0.00091059], 
                                        [ 0.00651411, -0.00352663, -0.00144585], 
                                        [ 0.02139752, -0.00941589, -0.00282025], 
                                        [-3.51263960e-15,  7.78447106e-15,  1.09387553e-14], 
                                        [ 0.00912293, -0.00267039, -0.00048275]]

      # Initial past base angular velocities manually retrieved from a standing pose
      initial_past_trajectory_base_ang_vel = [[-0.00755611, -0.0350876 , -0.0231277 ], 
                                            [0., 0., 0.], [-0.0087613 , -0.03888634, -0.027938  ], 
                                            [-0.0105522 , -0.04917967, -0.00152774], 
                                            [ 2.84504292e-16, -6.17399465e-16,  2.75187740e-15], 
                                            [-0.00168213, -0.04111259, -0.00753031], 
                                            [-0.00309745, -0.03786141, -0.03232349], 
                                            [-0.00704214, -0.02328724, -0.00895122], 
                                            [-0.01365813, -0.05655421,  0.00088823], 
                                            [8.54022144e-17, 1.48861722e-17, 2.82559492e-18], 
                                            [-0.0308838 , -0.07690305,  0.00853956], 
                                            [-1.70797352e-16, -2.97883444e-17, -5.77338249e-18], 
                                            [-0.00905094, -0.02452463, -0.00801273], 
                                            [-0.01191892, -0.07322378, -0.02738323], 
                                            [-0.00200355, -0.0343647 , -0.02822263], 
                                            [-0.00230115, -0.06715387, -0.11565876], 
                                            [-0.01534877, -0.05918849, -0.10457992], 
                                            [ 0.00594433, -0.04117897, -0.04580102], 
                                            [ 2.42486990e-16, -3.43752578e-16, -7.26415095e-15], 
                                            [ 0.00069116, -0.08983208, -0.1398635 ], 
                                            [-7.18915658e-16,  2.69132944e-15, -3.23792190e-17], 
                                            [ 0.01061373, -0.02487456, -0.00066224], 
                                            [ 0.01487274, -0.03206658, -0.02535907], 
                                            [ 0.01293469, -0.03481197, -0.01976739], 
                                            [ 0.00374153, -0.02509881, -0.0024132 ], 
                                            [ 0.00458413, -0.01476757,  0.01782594], 
                                            [ 0.00892151, -0.00587989,  0.01157207], 
                                            [ 0.01427018, -0.01349857,  0.01140695], 
                                            [ 0.02126881, -0.01271533, -0.00112174], 
                                            [ 0.04419007, -0.02972633, -0.01915061], 
                                            [0.00704018, 0.0167406 , 0.01190216], 
                                            [8.54525993e-17, 1.44741001e-17, 3.38442587e-18], 
                                            [ 0.02465543,  0.0231271 , -0.0269139 ], 
                                            [ 3.08885256e-16, -1.71101691e-17, -5.46882732e-15], 
                                            [0.03967082, 0.0946244 , 0.00762483], 
                                            [ 0.01492882,  0.01411408, -0.01669203], 
                                            [ 0.03444098, -0.027689  , -0.05422716], 
                                            [ 1.45933105e-16,  6.63493579e-16, -5.47416306e-15], 
                                            [ 0.05454233,  0.06117371, -0.06128212], 
                                            [ 0.01988478,  0.02682925, -0.02975806], 
                                            [ 0.00822804, -0.01885205, -0.03093768], 
                                            [ 0.0309434 , -0.07454498, -0.11478169], 
                                            [ 0.03355912, -0.00444326, -0.06843284], 
                                            [ 0.0540644 ,  0.03668021, -0.05470951], 
                                            [0.01472837, 0.02494858, 0.01199966], 
                                            [0.01405378, 0.03205797, 0.02029692], 
                                            [0.01825257, 0.03231723, 0.01303322], 
                                            [0.02497076, 0.02872931, 0.00766891], 
                                            [0.05355659, 0.04849043, 0.13106968], 
                                            [1.28251216e-16, 2.13485038e-17, 4.78841635e-18], 
                                            [0.01283283, 0.02187821, 0.07408406]]

    elif robot == "ergoCubV1": #TODO change all vels, current are for v2.5

      # Initial past base linear velocities manually retrieved from a standing pose
      initial_past_trajectory_base_vel = [[-0.00716343,  0.00385182,  0.00026315],
                                        [ 3.83626058e-15,  7.09872475e-15, -5.22836963e-15], 
                                        [-0.00675958,  0.00449099,  0.00059273], 
                                        [-0.00722386,  0.00551062,  0.00051982], 
                                        [-7.03736213e-15,  3.44515696e-15, -4.85989740e-16], 
                                        [-0.00676486,  0.00158084, -0.00026224], 
                                        [-0.00538534,  0.00128945,  0.00017258], 
                                        [-0.00331833,  0.00163447,  0.00042496], 
                                        [-0.00953416,  0.00254862,  0.00044421], 
                                        [-1.80269867e-15,  5.24949718e-15, -8.90842611e-17], 
                                        [-0.01330885,  0.00049532,  0.00115734], 
                                        [4.83036766e-15, 1.75945287e-15, 5.93309633e-15], 
                                        [-0.00349938, -0.00056845,  0.00053368], 
                                        [-0.01246749, -0.00152131,  0.000421  ], 
                                        [-0.00832295,  0.0004091 , -0.00032585], 
                                        [-0.01797435,  0.00017675, -0.00029361], 
                                        [-0.01288769,  0.00301351,  0.00084927], 
                                        [-0.00877806, -0.00043779, -0.00075292], 
                                        [ 1.40747243e-14, -6.89031391e-15,  9.71979480e-16], 
                                        [-0.02340612,  0.00397878, -0.00091494], 
                                        [-6.63306633e-15,  3.49004431e-15, -6.02218059e-15], 
                                        [-0.00865152,  0.00134653, -0.00177219], 
                                        [-0.00786997, -0.00233357, -0.00156049], 
                                        [-0.00892424, -0.00258245, -0.00146873], 
                                        [-0.00811743,  0.00200219, -0.00099574], 
                                        [-0.01302307,  0.00418385, -0.00174521], 
                                        [-0.00462916,  0.00026048, -0.00119211], 
                                        [-0.0050965 , -0.00139854, -0.00160158], 
                                        [-0.005476  , -0.00227114, -0.00200646], 
                                        [-0.01676012, -0.00561986, -0.00489061], 
                                        [ 0.00264328, -0.00101225, -0.00052074], 
                                        [ 5.40809601e-15, -1.57484915e-14,  2.67252783e-16], 
                                        [-0.0027995 , -0.00375919, -0.00231512], 
                                        [ 1.80269867e-15, -5.24949718e-15,  8.90842611e-17], 
                                        [ 0.01081781, -0.00782894, -0.00248261], 
                                        [ 0.00139013, -0.00224276, -0.00093824], 
                                        [-0.00658927, -0.00711429, -0.00251821], 
                                        [-4.97053540e-16,  2.66963594e-15, -5.58073298e-15], 
                                        [ 0.00104704, -0.00982987, -0.00381658], 
                                        [ 0.00307704, -0.00356778, -0.00104486], 
                                        [-0.00066357, -0.00226427, -0.00036987], 
                                        [-0.01301264, -0.00357357, -0.00220798], 
                                        [-0.00417191, -0.00309992, -0.00233419], 
                                        [ 0.00640315, -0.00554543, -0.00296235], 
                                        [ 0.00687916, -0.00118332, -0.00065244], 
                                        [ 0.00819684, -0.00063089, -0.00048392], 
                                        [ 0.00726917, -0.00193537, -0.00091059], 
                                        [ 0.00651411, -0.00352663, -0.00144585], 
                                        [ 0.02139752, -0.00941589, -0.00282025], 
                                        [-3.51263960e-15,  7.78447106e-15,  1.09387553e-14], 
                                        [ 0.00912293, -0.00267039, -0.00048275]]
        
      #TODO these are vals for v2.5
      # Initial past base angular velocities manually retrieved from a standing pose
      initial_past_trajectory_base_ang_vel = [[-0.00755611, -0.0350876 , -0.0231277 ], 
                                            [0., 0., 0.], [-0.0087613 , -0.03888634, -0.027938  ], 
                                            [-0.0105522 , -0.04917967, -0.00152774], 
                                            [ 2.84504292e-16, -6.17399465e-16,  2.75187740e-15], 
                                            [-0.00168213, -0.04111259, -0.00753031], 
                                            [-0.00309745, -0.03786141, -0.03232349], 
                                            [-0.00704214, -0.02328724, -0.00895122], 
                                            [-0.01365813, -0.05655421,  0.00088823], 
                                            [8.54022144e-17, 1.48861722e-17, 2.82559492e-18], 
                                            [-0.0308838 , -0.07690305,  0.00853956], 
                                            [-1.70797352e-16, -2.97883444e-17, -5.77338249e-18], 
                                            [-0.00905094, -0.02452463, -0.00801273], 
                                            [-0.01191892, -0.07322378, -0.02738323], 
                                            [-0.00200355, -0.0343647 , -0.02822263], 
                                            [-0.00230115, -0.06715387, -0.11565876], 
                                            [-0.01534877, -0.05918849, -0.10457992], 
                                            [ 0.00594433, -0.04117897, -0.04580102], 
                                            [ 2.42486990e-16, -3.43752578e-16, -7.26415095e-15], 
                                            [ 0.00069116, -0.08983208, -0.1398635 ], 
                                            [-7.18915658e-16,  2.69132944e-15, -3.23792190e-17], 
                                            [ 0.01061373, -0.02487456, -0.00066224], 
                                            [ 0.01487274, -0.03206658, -0.02535907], 
                                            [ 0.01293469, -0.03481197, -0.01976739], 
                                            [ 0.00374153, -0.02509881, -0.0024132 ], 
                                            [ 0.00458413, -0.01476757,  0.01782594], 
                                            [ 0.00892151, -0.00587989,  0.01157207], 
                                            [ 0.01427018, -0.01349857,  0.01140695], 
                                            [ 0.02126881, -0.01271533, -0.00112174], 
                                            [ 0.04419007, -0.02972633, -0.01915061], 
                                            [0.00704018, 0.0167406 , 0.01190216], 
                                            [8.54525993e-17, 1.44741001e-17, 3.38442587e-18], 
                                            [ 0.02465543,  0.0231271 , -0.0269139 ], 
                                            [ 3.08885256e-16, -1.71101691e-17, -5.46882732e-15], 
                                            [0.03967082, 0.0946244 , 0.00762483], 
                                            [ 0.01492882,  0.01411408, -0.01669203], 
                                            [ 0.03444098, -0.027689  , -0.05422716], 
                                            [ 1.45933105e-16,  6.63493579e-16, -5.47416306e-15], 
                                            [ 0.05454233,  0.06117371, -0.06128212], 
                                            [ 0.01988478,  0.02682925, -0.02975806], 
                                            [ 0.00822804, -0.01885205, -0.03093768], 
                                            [ 0.0309434 , -0.07454498, -0.11478169], 
                                            [ 0.03355912, -0.00444326, -0.06843284], 
                                            [ 0.0540644 ,  0.03668021, -0.05470951], 
                                            [0.01472837, 0.02494858, 0.01199966], 
                                            [0.01405378, 0.03205797, 0.02029692], 
                                            [0.01825257, 0.03231723, 0.01303322], 
                                            [0.02497076, 0.02872931, 0.00766891], 
                                            [0.05355659, 0.04849043, 0.13106968], 
                                            [1.28251216e-16, 2.13485038e-17, 4.78841635e-18], 
                                            [0.01283283, 0.02187821, 0.07408406]]

    else:
        raise Exception("Initial past trajectory data only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return initial_past_trajectory_base_vel, initial_past_trajectory_base_ang_vel

def define_initial_base_height(robot: str) -> List:
    """Define the robot-specific initial height of the base frame."""

    if robot == "iCubV2_5":
        initial_base_height = 0.6354

    elif robot == "iCubV3":
        initial_base_height = 0.63

    elif robot == "ergoCubV1":
        initial_base_height = 0.7754

    else:
        raise Exception("Initial base height only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return initial_base_height

def define_base_pitch_offset(robot: str) -> List:
    """Define the robot-specific pitch offset for the base frame."""

    if robot == "iCubV2_5":
        base_pitch_offset = 0

    elif robot == "iCubV3":
        base_pitch_offset = - 0.09

    elif robot == "ergoCubV1":
        base_pitch_offset = - 0.09

    else:
        raise Exception("Base pitch offset only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return base_pitch_offset

def define_initial_support_foot_and_vertex(robot: str) -> List:
    """Define the robot-specific initial support foot and vertex."""

    if robot == "iCubV2_5":
        initial_support_foot = "right_foot"
        initial_support_vertex = 0

    elif robot == "iCubV3":
        initial_support_foot = "right_foot"
        initial_support_vertex = 0

    elif robot == "ergoCubV1":
        initial_support_foot = "right_foot"
        initial_support_vertex = 0

    else:
        raise Exception("Initial support foot and vertex only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return initial_support_foot, initial_support_vertex

def define_initial_base_yaw(robot: str) -> List:
    """Define the robot-specific initial base yaw expressed in the world frame."""

    if robot == "iCubV2_5":
        # For iCubV2_5, the initial base yaw is 180 degs since the x axis of the base frame points backward
        initial_base_angle = np.array([0.0, 0.0, math.pi])

    elif robot == "iCubV3":
        # For iCubV3, the initial base yaw is 0 degs since the x axis of the base frame points forward
        initial_base_angle = np.array([0.0, 0.0, 0.0])

    elif robot == "ergoCubV1":
        # For ergoCubV1, the initial base yaw is 0 degs since the x axis of the base frame points forward
        initial_base_angle = np.array([0.0, 0.0, 0.0])

    else:
        raise Exception("Initial base yaw only defined for iCubV2_5, iCubV3 and ergoCubV1.")

    return initial_base_angle

def trajectory_blending(a0: List, a1: List, t: np.array, tau: float) -> List:
    """Blend the vectors a0 and a1 via:
           Blend(a0, a1, t, tau) = (1 - t^tau) a0 + t^tau a1
       Increasing tau means biasing more towards a1.
    """

    blended_trajectory = []

    for i in range(len(t)):
        p_i = (1 - math.pow(t[i], tau)) * np.array(a0[i]) + math.pow(t[i], tau) * np.array(a1[i])
        blended_trajectory.append(p_i.tolist())

    return blended_trajectory

def load_component_wise_input_mean_and_std(datapath: str) -> (Dict, Dict):
    """Compute component-wise input mean and standard deviation."""

    # Full-input mean and std
    Xmean = read_from_file(datapath + 'X_mean.txt')
    Xstd = read_from_file(datapath + 'X_std.txt')

    # Remove zeroes from Xstd
    for i in range(Xstd.size):
        if Xstd[i] == 0:
            Xstd[i] = 1

    # Retrieve component-wise input mean and std (used to normalize the next input for the network)
    Xmean_dict = {"past_base_velocities": Xmean[0:18]}
    Xstd_dict = {"past_base_velocities": Xstd[0:18]}
    Xmean_dict["future_base_velocities"] = Xmean[18:36]
    Xstd_dict["future_base_velocities"] = Xstd[18:36]
    Xmean_dict["past_base_angular_velocities"] = Xmean[36:54]
    Xstd_dict["past_base_angular_velocities"] = Xstd[36:54]
    Xmean_dict["future_base_angular_velocities"] = Xmean[54:72]
    Xstd_dict["future_base_angular_velocities"] = Xstd[54:72]
    Xmean_dict["s"] = Xmean[72:104]
    Xstd_dict["s"] = Xstd[72:104]
    Xmean_dict["s_dot"] = Xmean[104:]
    Xstd_dict["s_dot"] = Xstd[104:]

    return Xmean_dict, Xstd_dict

def load_output_mean_and_std(datapath: str) -> (List, List):
    """Compute output mean and standard deviation."""

    # Full-output mean and std
    Ymean = read_from_file(datapath + 'Y_mean.txt')
    Ystd = read_from_file(datapath + 'Y_std.txt')

    # Remove zeroes from Ystd
    for i in range(Ystd.size):
        if Ystd[i] == 0:
            Ystd[i] = 1

    return Ymean, Ystd

# ===================
# VISUALIZATION UTILS
# ===================

def visualize_generated_motion(icub: iCub,
                               controlled_joints_indexes: List,
                               gazebo: scenario.GazeboSimulator,
                               posturals: Dict,
                               raw_data: List,
                               blending_coeffs: Dict,
                               plot_blending_coeffs: bool = False,
                               plot_joystick_inputs: bool = False,
                               plot_com: bool = False,
                               plot_momentum: bool = False) -> None:
    """Visualize the generated motion, optionally along with the joystick inputs used to generate it, the activations
    of the blending coefficients, the com and the momentum evolution during the trajectory generation."""

    # Extract posturals
    joint_pos_posturals = posturals["joints_pos"]
    joint_vel_posturals = posturals["joints_vel"]
    base_posturals = posturals["base"]
    com_pos_posturals = posturals["com_pos"]
    com_vel_posturals = posturals["com_vel"]
    centroidal_momentum_posturals = posturals["centroidal_momentum"]

    # Retrieve blending coefficients
    if plot_blending_coeffs:
        w_1 = blending_coeffs["w_1"]
        w_2 = blending_coeffs["w_2"]
        w_3 = blending_coeffs["w_3"]
        w_4 = blending_coeffs["w_4"]

    # Define controlled joints
    icub_joints = icub.joint_names()

    # Plot configuration
    plt.ion()

    for frame_idx in range(len(joint_pos_posturals)):

        # Debug
        print(frame_idx, "/", len(joint_pos_posturals))

        # Plot configuration
        xticks = [i for i in range(0, frame_idx, 100)]
        xtick_labels = [str(i / 100) for i in range(0, frame_idx, 100)]

        # ======================
        # VISUALIZE ROBOT MOTION
        # ======================

        # Retrieve the current joint positions
        joint_postural = joint_pos_posturals[frame_idx]

        full_joint_positions = np.zeros(len(icub_joints))
        for index in controlled_joints_indexes:
            full_joint_positions[index] = joint_postural[icub_joints[index]]

        # Retrieve the current base position and orientation
        base_postural = base_posturals[frame_idx]
        base_position = base_postural['position']
        base_quaternion = base_postural['wxyz_quaternions']

        # Reset the robot configuration in the simulator
        icub.to_gazebo().reset_base_pose(base_position, base_quaternion)
        icub.to_gazebo().reset_joint_positions(full_joint_positions, icub_joints)
        gazebo.run(paused=True)

        # =====================================
        # PLOT THE MOTION DIRECTION ON FIGURE 1
        # =====================================

        if plot_joystick_inputs:

            # Retrieve the current motion direction
            curr_raw_data = raw_data[frame_idx]
            curr_x = curr_raw_data[0]
            curr_y = curr_raw_data[1]

            plt.figure(1)
            plt.clf()

            # Circumference of unitary radius
            r = 1
            x = np.linspace(-r, r, 1000)
            y = np.sqrt(-x ** 2 + r ** 2)
            plt.plot(x, y, 'r')
            plt.plot(x, -y, 'r')

            # Motion direction
            plt.scatter(0, 0, c='r')
            desired_motion_direction = plt.arrow(0, 0, curr_x, -curr_y, length_includes_head=True, width=0.01,
                                                 head_width=8 * 0.01, head_length=1.8 * 8 * 0.01, color='r')

            # Plot configuration
            plt.axis('scaled')
            plt.xlim([-1.2, 1.2])
            plt.ylim([-1.4, 1.2])
            plt.axis('off')
            plt.legend([desired_motion_direction], ['DESIRED MOTION DIRECTION'], loc="lower center")

        # =====================================
        # PLOT THE FACING DIRECTION ON FIGURE 2
        # =====================================

        if plot_joystick_inputs:

            # Retrieve the current facing direction
            curr_z = curr_raw_data[2]
            curr_rz = curr_raw_data[3]

            plt.figure(2)
            plt.clf()

            # Circumference of unitary norm
            r = 1
            x = np.linspace(-r, r, 1000)
            y = np.sqrt(-x ** 2 + r ** 2)
            plt.plot(x, y, 'b')
            plt.plot(x, -y, 'b')

            # Facing direction
            plt.scatter(0, 0, c='b')
            desired_facing_direction = plt.arrow(0, 0, curr_z, -curr_rz, length_includes_head=True, width=0.01,
                                                 head_width=8 * 0.01, head_length=1.8 * 8 * 0.01, color='b')

            # Plot configuration
            plt.axis('scaled')
            plt.xlim([-1.2, 1.2])
            plt.ylim([-1.4, 1.2])
            plt.axis('off')
            plt.legend([desired_facing_direction], ['DESIRED FACING DIRECTION'], loc="lower center")

        # ==========================================
        # PLOT THE BLENDING COEFFICIENTS ON FIGURE 3
        # ==========================================

        if plot_blending_coeffs:

            # Retrieve the blending coefficients up to the current time
            curr_w_1 = w_1[:frame_idx]
            curr_w_2 = w_2[:frame_idx]
            curr_w_3 = w_3[:frame_idx]
            curr_w_4 = w_4[:frame_idx]

            plt.figure(3)
            plt.clf()

            plt.plot(range(len(curr_w_1)), curr_w_1, 'r')
            plt.plot(range(len(curr_w_2)), curr_w_2, 'b')
            plt.plot(range(len(curr_w_3)), curr_w_3, 'g')
            plt.plot(range(len(curr_w_4)), curr_w_4, 'y')

            # Plot configuration
            plt.xticks(xticks, xtick_labels)
            plt.title("Blending coefficients profiles")
            plt.xlim([0, len(w_1)])
            plt.ylabel("Blending coefficients")
            plt.xlabel("Time [s]")

        # ============
        # PLOT COM POS
        # ============

        if plot_com:

            # Retrieve the com pos posturals up to the current time
            com_pos_postural = com_pos_posturals[:frame_idx]
            com_pos_postural_x = [elem[0] for elem in com_pos_postural]
            com_pos_postural_y = [elem[1] for elem in com_pos_postural]
            com_pos_postural_z = [elem[2] for elem in com_pos_postural]

            plt.figure(4)
            plt.clf()

            plt.plot(range(len(com_pos_postural_x)), com_pos_postural_x, label='x', color='r')
            plt.plot(range(len(com_pos_postural_y)), com_pos_postural_y, label='y', color='y')
            plt.plot(range(len(com_pos_postural_z)), com_pos_postural_z, label='z', color='b')

            # Plot configuration
            plt.xticks(xticks, xtick_labels)
            plt.title("Com positions")
            plt.ylabel("CoM positions [m]")
            plt.xlabel("Time [s]")
            plt.legend()

        # ============
        # PLOT COM VEL
        # ============

        if plot_com:

            # Retrieve the com vel posturals up to the current time
            com_vel_postural = com_vel_posturals[:frame_idx]
            com_vel_postural_x = [elem[0] for elem in com_vel_postural]
            com_vel_postural_y = [elem[1] for elem in com_vel_postural]
            com_vel_postural_z = [elem[2] for elem in com_vel_postural]

            plt.figure(5)
            plt.clf()

            plt.plot(range(len(com_vel_postural_x)), com_vel_postural_x, label='x', color='r')
            plt.plot(range(len(com_vel_postural_y)), com_vel_postural_y, label='y', color='y')
            plt.plot(range(len(com_vel_postural_z)), com_vel_postural_z, label='z', color='b')

            # Plot configuration
            plt.xticks(xticks, xtick_labels)
            plt.title("Com velocities")
            plt.ylabel("CoM velocities [m/s]")
            plt.xlabel("Time [s]")
            plt.legend()

        # ====================
        # PLOT LINEAR MOMENTUM
        # ====================

        if plot_momentum:

            # Retrieve the linear momentum postural up to the current time
            centroidal_momentum_postural = centroidal_momentum_posturals[:frame_idx]
            linear_momentum_postural = [elem[0] for elem in centroidal_momentum_postural]
            linear_momentum_postural_x = [elem[0] for elem in linear_momentum_postural]
            linear_momentum_postural_y = [elem[1] for elem in linear_momentum_postural]
            linear_momentum_postural_z = [elem[2] for elem in linear_momentum_postural]

            plt.figure(6)
            plt.clf()

            plt.plot(range(len(linear_momentum_postural_x)), linear_momentum_postural_x, label='x', color='r')
            plt.plot(range(len(linear_momentum_postural_y)), linear_momentum_postural_y, label='y', color='y')
            plt.plot(range(len(linear_momentum_postural_z)), linear_momentum_postural_z, label='z', color='b')

            # Plot configuration
            plt.xticks(xticks, xtick_labels)
            plt.title("Linear momentum")
            plt.ylabel("Linear momentum [kg * m/s]")
            plt.xlabel("Time [s]")
            plt.legend()

        # =====================
        # PLOT ANGULAR MOMENTUM
        # =====================

        if plot_momentum:

            # Retrieve the angular momentum postural up to the current time
            angular_momentum_postural = [elem[1] for elem in centroidal_momentum_postural]
            angular_momentum_postural_x = [elem[0] for elem in angular_momentum_postural]
            angular_momentum_postural_y = [elem[1] for elem in angular_momentum_postural]
            angular_momentum_postural_z = [elem[2] for elem in angular_momentum_postural]

            plt.figure(7)
            plt.clf()

            plt.plot(range(len(angular_momentum_postural_x)), angular_momentum_postural_x, label='x', color='r')
            plt.plot(range(len(angular_momentum_postural_y)), angular_momentum_postural_y, label='y', color='y')
            plt.plot(range(len(angular_momentum_postural_z)), angular_momentum_postural_z, label='z', color='b')


            # Plot configuration
            plt.xticks(xticks, xtick_labels)
            plt.title("Angular momentum")
            plt.ylabel("Angular momentum [kg * m * m/s]")
            plt.xlabel("Time [s/]")
            plt.legend()

        if plot_blending_coeffs or plot_joystick_inputs or plot_com or plot_momentum:
            # Plot
            plt.show()
            plt.pause(0.0001)
        else:
            # Show robot motion in real time
            time.sleep(0.01)

    input("Press Enter to end the visualization of the generated trajectory.")

